<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbox - Sogang Team Building</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body style="height: 100vh; overflow: hidden; display: flex; flex-direction: column;">

    <header id="main-header"></header>

    <main class="container" style="flex: 1; padding: 0 1rem; max-width: 1400px; height: calc(100vh - 4rem - 2rem);">

        <div class="inbox-layout" style="display: flex; height: 100%; gap: 1rem; padding-bottom: 2rem;">

            <!-- Sidebar: Friends -->
            <div class="thread-list"
                style="width: 320px; display: flex; flex-direction: column; background: white; border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden;">
                <div style="padding: 1.25rem; border-bottom: 1px solid var(--color-border); background: white;">
                    <h2 style="font-size: 1.25rem; margin: 0;">Friends</h2>
                    <p style="font-size: 0.8rem; color: var(--color-text-tertiary); margin-top: 0.25rem;">Direct
                        Messaging</p>
                </div>

                <div id="friends-list-container" style="flex: 1; overflow-y: auto; background: #fff;">
                    <!-- Skeleton Loading -->
                    <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"
                                    style="width: 50%; height: 1rem; margin-bottom: 0.4rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"
                                    style="width: 50%; height: 1rem; margin-bottom: 0.4rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"
                                    style="width: 50%; height: 1rem; margin-bottom: 0.4rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"
                                    style="width: 50%; height: 1rem; margin-bottom: 0.4rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            </div>
                        </div>
                    </div>
                    <div style="padding: 1rem; border-bottom: 1px solid var(--color-border);">
                        <div style="display: flex; gap: 0.75rem; align-items: center;">
                            <div class="skeleton skeleton-circle" style="width: 48px; height: 48px;"></div>
                            <div style="flex: 1;">
                                <div class="skeleton skeleton-title"
                                    style="width: 50%; height: 1rem; margin-bottom: 0.4rem;"></div>
                                <div class="skeleton skeleton-text" style="width: 80%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main: Chat Window -->
            <div class="chat-window"
                style="flex: 1; display: flex; flex-direction: column; background: white; border: 1px solid var(--color-border); border-radius: 8px; overflow: hidden;">
                <!-- No Thread Selected View -->
                <div id="no-thread-selected"
                    style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--color-text-tertiary); text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ’¬</div>
                    <p>Select a friend to start chatting.</p>
                </div>

                <!-- Active Chat View -->
                <div id="active-chat" style="display: none; flex-direction: column; height: 100%;">
                    <!-- Chat Header -->
                    <div
                        style="padding: 1rem 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between; background: white;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div id="thread-avatar"
                                style="width: 40px; height: 40px; border-radius: 50%; background: #EEE; overflow: hidden;">
                            </div>
                            <div>
                                <h3 id="thread-title" style="margin: 0; font-size: 1.1rem;">Thread Title</h3>
                                <p id="thread-status" style="margin: 0; font-size: 0.8rem; color: #2ecc71;">Online</p>
                            </div>
                        </div>
                    </div>

                    <!-- Messages -->
                    <div id="chat-messages" class="chat-messages"
                        style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #f9f9f9; display: flex; flex-direction: column;">
                        <!-- Messages go here -->
                    </div>

                    <!-- Input -->
                    <form id="chat-form" class="chat-input-area"
                        style="padding: 1rem; background: white; border-top: 1px solid var(--color-border); display: flex; gap: 0.75rem;">
                        <input type="text" id="chat-input" class="input" placeholder="Type a message..." required
                            autocomplete="off" style="flex: 1;">
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>

        </div>

    </main>

    <script src="./js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const friendsContainer = document.getElementById('friends-list-container');
            const chatMessages = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const noThreadView = document.getElementById('no-thread-selected');
            const activeChatView = document.getElementById('active-chat');

            const currentUser = window.db.getCurrentUser();
            let activeFriendId = null;
            let activeThreadId = null;

            if (!currentUser) {
                window.location.href = './auth/login.html';
                return;
            }

            // === Load Friends & Sort by Newest Message ===
            let lastKnownMessageTime = null;

            async function loadFriends() {
                const friends = await window.db.getFriends();
                const threads = await window.db.getInbox();

                // Merge and Sort
                const mergedList = friends.map(f => {
                    const thread = threads.find(t => t.type === 'dm' && t.users.some(u => u._id === f._id));
                    return { ...f, thread };
                });

                // Sort by lastMessageAt (descending), items with no messages go to bottom
                mergedList.sort((a, b) => {
                    const timeA = a.thread?.lastMessageAt ? new Date(a.thread.lastMessageAt).getTime() : 0;
                    const timeB = b.thread?.lastMessageAt ? new Date(b.thread.lastMessageAt).getTime() : 0;
                    return timeB - timeA;
                });

                // Check for overall newest message to trigger alert
                const newestThread = threads[0]; // Already sorted by backend
                if (newestThread && newestThread.lastMessageAt) {
                    const newestTime = new Date(newestThread.lastMessageAt).getTime();
                    // Alert only if it's a new message (newer than last check), NOT from me, and we aren't already in THAT thread
                    if (lastKnownMessageTime && newestTime > lastKnownMessageTime) {
                        const lastMsg = newestThread.lastMessage;
                        if (lastMsg) {
                            const senderId = String(lastMsg.sender?._id || lastMsg.sender);
                            const myId = String(currentUser.id || currentUser._id);
                            if (senderId !== myId && String(newestThread._id) !== String(activeThreadId)) {
                                alert('(new message)');
                            }
                        }
                    }
                    lastKnownMessageTime = newestTime;
                }

                if (mergedList.length === 0) {
                    friendsContainer.innerHTML = '<p style="padding: 2rem; text-align: center; color: var(--color-text-tertiary);">No friends yet.<br><small>Connect with others in "Find Members"!</small></p>';
                    return;
                }

                friendsContainer.innerHTML = mergedList.map(item => {
                    const friend = item;
                    const thread = item.thread;
                    const lastMsg = thread?.lastMessage ? thread.lastMessage.text : 'No messages yet';
                    const time = thread?.lastMessageAt ? new Date(thread.lastMessageAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
                    const isActive = friend._id === activeFriendId;

                    // Unread check
                    const lastMsgObj = thread?.lastMessage;
                    const myId = String(currentUser.id || currentUser._id);
                    const isUnread = lastMsgObj &&
                        String(lastMsgObj.sender?._id || lastMsgObj.sender) !== myId &&
                        !lastMsgObj.readBy?.some(r => String(r) === myId);

                    return `
                        <div class="thread-item ${isActive ? 'active' : ''}" onclick="openDM('${friend._id}', '${friend.name}')" style="padding: 1rem; border-bottom: 1px solid var(--color-border); cursor: pointer; transition: background 0.2s; background: ${isActive ? '#f8f9fa' : 'white'}; border-left: 4px solid ${isActive ? 'var(--color-sogang-red)' : 'transparent'};">
                            <div style="display: flex; gap: 0.75rem; align-items: center;">
                                <div style="width: 48px; height: 48px; border-radius: 50%; background: #EEE; overflow: hidden; flex-shrink: 0; border: 1px solid #eee; position: relative;">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${friend.name}" style="width: 100%; height: 100%;">
                                    ${isUnread ? '<div style="position: absolute; top: 0; right: 0; width: 12px; height: 12px; background: #e74c3c; border-radius: 50%; border: 2px solid white;"></div>' : ''}
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.15rem;">
                                        <h4 style="margin: 0; font-size: 0.95rem; font-weight: ${isUnread ? '700' : '600'}; color: var(--color-text-primary);">${friend.name}</h4>
                                        <span style="font-size: 0.7rem; color: ${isUnread ? '#e74c3c' : 'var(--color-text-tertiary)'}; font-weight: ${isUnread ? '700' : 'normal'}">${isUnread ? '(New) ' : ''}${time}</span>
                                    </div>
                                    <p style="margin: 0; font-size: 0.8rem; color: ${isUnread ? 'var(--color-text-primary)' : 'var(--color-text-secondary)'}; font-weight: ${isUnread ? '500' : 'normal'}; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                        ${lastMsg}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            window.openDM = async (friendId, name) => {
                activeFriendId = friendId;
                noThreadView.style.display = 'none';
                activeChatView.style.display = 'flex';

                // Get or Create Thread
                const thread = await window.db.getOrCreateDM(friendId);
                if (thread && thread._id) {
                    activeThreadId = thread._id;

                    // Update Header
                    document.getElementById('thread-title').textContent = name;
                    document.getElementById('thread-avatar').innerHTML = `<img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${name}" style="width: 100%; height: 100%;">`;

                    loadMessages(activeThreadId);
                    loadFriends(); // Refresh sidebar highlighting
                } else {
                    alert('Could not start chat: ' + (thread.error || 'Server error'));
                }
            };

            async function loadMessages(threadId) {
                if (activeThreadId !== threadId) return;
                const messages = await window.db.getThreadMessages(threadId);
                chatMessages.innerHTML = messages.map(m => {
                    const isMe = (m.sender._id === currentUser.id || m.sender._id === currentUser._id);
                    return `
                        <div class="message ${isMe ? 'sent' : 'received'}" style="margin-bottom: 0.75rem; max-width: 80%; ${isMe ? 'align-self: flex-end;' : 'align-self: flex-start;'}">
                            <div style="padding: 0.75rem 1rem; border-radius: 12px; font-size: 0.95rem; ${isMe ? 'background: var(--color-sogang-red); color: white; border-bottom-right-radius: 2px;' : 'background: #fff; color: var(--color-text-primary); border-bottom-left-radius: 2px; border: 1px solid #eee;'}">
                                ${m.text}
                            </div>
                            <div style="font-size: 0.65rem; color: #888; margin-top: 0.2rem; text-align: ${isMe ? 'right' : 'left'};">
                                ${new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                    `;
                }).join('');
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const text = chatInput.value.trim();
                if (!text || !activeThreadId) return;

                const res = await window.db.sendMessage(activeThreadId, text);
                if (!res.error) {
                    chatInput.value = '';
                    await loadMessages(activeThreadId);
                    loadFriends(); // Update last message in sidebar
                } else {
                    alert('Error: ' + res.error);
                }
            });

            loadFriends();

            // Auto-refresh messages and friend list
            setInterval(() => {
                if (activeThreadId) loadMessages(activeThreadId);
                loadFriends();
            }, 5000);
        });
    </script>
</body>

</html>