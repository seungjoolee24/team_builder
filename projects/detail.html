<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Details - Sogang Team Building</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>

    <header id="main-header"></header>

    <main class="container" style="padding: 3rem 1rem;">

        <div id="project-content">
            <!-- Loading -->
        </div>

    </main>

    <footer id="main-footer"></footer>

    <!-- Application Modal -->
    <div id="apply-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div class="card" style="width: 100%; max-width: 500px; padding: 2rem;">
            <h3 style="margin-bottom: 1rem;">Apply to Project</h3>
            <div class="input-group">
                <label class="label">Select Preferred Roles (Multiple selection possible)</label>
                <div id="apply-roles-container"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; background: var(--color-bg-secondary); padding: 1rem; border-radius: 8px;">
                    <!-- Checkboxes injected -->
                </div>
            </div>
            <div class="input-group">
                <label class="label">Motivation / Introduction</label>
                <textarea id="apply-msg" class="input" rows="4" placeholder="Why do you want to join?"></textarea>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button id="cancel-apply" class="btn btn-secondary">Cancel</button>
                <button id="submit-apply" class="btn btn-primary">Submit Application</button>
            </div>
        </div>
    </div>

    <script src="../js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('id');

            const project = await window.db.getProjectById(projectId);

            if (!project) {
                document.getElementById('project-content').innerHTML = `<h2>Project Not Found</h2><a href="./join.html" class="btn btn-primary">Back to List</a>`;
                return;
            }

            // Determine User Status & Button
            const currentUser = window.db.getCurrentUser();
            let actionButton = `<button id="apply-btn" class="btn btn-primary" style="width: 100%;">Apply Now</button>`;

            if (currentUser) {
                const userId = currentUser.id;

                // Check Owner
                const isOwner = project.owner === userId || (typeof project.owner === 'object' && project.owner._id === userId);

                // Check Member
                const isMember = project.members && project.members.some(m => m.user === userId || (typeof m.user === 'object' && m.user._id === userId));

                // Check Pending Application
                const isPending = project.applications && project.applications.some(app =>
                    (app.applicant === userId || (typeof app.applicant === 'object' && app.applicant._id === userId)) && app.status === 'PENDING'
                );

                if (isOwner) {
                    actionButton = `<a href="../workspace.html?id=${projectId}" class="btn" style="display:block; width: 100%; background-color: var(--color-sogang-red); color: white; text-align:center; text-decoration:none;">Manage Project</a>`;
                } else if (isMember) {
                    actionButton = `<a href="../workspace.html?id=${projectId}" class="btn" style="display:block; width: 100%; background-color: #28a745; color: white; text-align:center; text-decoration:none;">Enter Workspace</a>`;
                } else if (isPending) {
                    actionButton = `<button class="btn" style="width: 100%; background-color: #ffc107; color: black; cursor: default;" disabled>Application Pending</button>`;
                }
            }

            // Render Content
            document.getElementById('project-content').innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <a href="./join.html" style="color: var(--color-text-secondary); font-size: 0.9rem;">&larr; Back to Projects</a>
                </div>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 3rem;">
                    
                    <div>
                        <span class="badge blue" style="margin-bottom: 1rem;">${project.type || 'Project'}</span>
                        <h1 style="font-size: 2.5rem; margin-bottom: 0.5rem;">${project.title}</h1>
                        <p style="font-size: 1.25rem; color: var(--color-text-secondary); margin-bottom: 2rem;">${project.summary || ''}</p>
                        
                        <section class="card" style="margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem;">Project Description</h3>
                            <p style="white-space: pre-wrap; color: var(--color-text-secondary); line-height: 1.6;">${project.description || 'No description provided.'}</p>
                        </section>

                        <section class="card">
                            <h3 style="margin-bottom: 1rem;">Domain & Skills</h3>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                <span class="badge purple">${project.domain || 'General'}</span>
                                <!-- Mock Skills -->
                                <span class="badge">React</span>
                                <span class="badge">Node.js</span>
                            </div>
                        </section>
                    </div>

                    <aside>
                        <div class="card" style="position: sticky; top: 6rem;">
                            <h3 style="margin-bottom: 1.5rem;">Recruitment Status</h3>
                            
                            <div style="margin-bottom: 1.5rem;">
                                ${(project.roles || []).map(r => `
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem; font-size: 0.95rem;">
                                        <span style="font-weight: 500;">${r.role}</span>
                                        <span style="color: ${(r.filled || 0) >= r.count ? 'var(--color-text-secondary)' : 'var(--color-sogang-red)'}; font-weight: 600;">
                                            ${r.filled || 0}/${r.count}
                                        </span>
                                    </div>
                                    <div style="width: 100%; height: 6px; background: var(--color-bg-tertiary); border-radius: 3px; margin-bottom: 1rem;">
                                        <div style="width: ${((r.filled || 0) / r.count) * 100}%; height: 100%; background: var(--color-sogang-red); border-radius: 3px;"></div>
                                    </div>
                                `).join('')}
                                
                                <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                        <span style="font-weight: 600;">Total Team Members</span>
                                        <span style="font-weight: 700; color: var(--color-sogang-red);">
                                            ${(project.members && project.members.length > 0 ? project.members.length : 1)} / ${(project.roles || []).reduce((acc, r) => acc + Number(r.count || 0), 0) + 1}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            ${actionButton}
                            <p style="text-align: center; font-size: 0.8rem; color: var(--color-text-tertiary); margin-top: 1rem;">
                                Leader: ${typeof project.owner === 'object' ? project.owner.name : 'Unknown'} 
                                (${(project.members || []).find(m => {
                const mId = typeof m.user === 'object' ? m.user._id : m.user;
                const oId = typeof project.owner === 'object' ? project.owner._id : project.owner;
                return String(mId) === String(oId);
            })?.role || 'Leader'})
                            </p>
                        </div>
                    </aside>

                </div>
            `;

            // Apply Modal Logic
            const modal = document.getElementById('apply-modal');
            const applyBtn = document.getElementById('apply-btn');
            const cancelBtn = document.getElementById('cancel-apply');
            const submitBtn = document.getElementById('submit-apply');
            const roleSelect = document.getElementById('apply-role');

            if (applyBtn) {
                applyBtn.addEventListener('click', () => {
                    // Check auth first
                    const currentUser = window.db.getCurrentUser();
                    if (!currentUser) {
                        alert('Please log in to apply.');
                        window.location.href = '../auth/login.html';
                        return;
                    }

                    // Populate Roles as Checkboxes
                    const rolesContainer = document.getElementById('apply-roles-container');
                    rolesContainer.innerHTML = (project.roles || [])
                        .filter(r => (r.filled || 0) < r.count)
                        .map(r => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                                <input type="checkbox" name="apply-role" value="${r.role}">
                                ${r.role}
                            </label>
                        `)
                        .join('');

                    if (rolesContainer.children.length === 0) {
                        alert('This project is full!');
                        return;
                    }

                    modal.style.display = 'flex';
                });
            }

            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            submitBtn.addEventListener('click', async () => {
                const selectedRoles = Array.from(document.querySelectorAll('input[name="apply-role"]:checked')).map(cb => cb.value);
                const msg = document.getElementById('apply-msg').value;

                if (selectedRoles.length === 0) return alert('Please select at least one role.');

                const result = await window.db.createApplication(projectId, selectedRoles, msg);

                if (result.success) {
                    alert('Application sent successfully! The team leader will review it.');
                    modal.style.display = 'none';
                    window.location.reload();
                } else {
                    alert('Application Failed: ' + result.message);
                    modal.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>