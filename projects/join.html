<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Find Projects - Sogang Team Building</title>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .filter-sidebar {
            width: 260px;
            flex-shrink: 0;
        }

        .projects-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--color-sogang-red);
            border-bottom-color: var(--color-sogang-red);
            font-weight: 600;
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group h4 {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--color-text-primary);
        }
    </style>
</head>

<body>

    <header id="main-header"></header>

    <main class="container" style="padding: 2rem 1rem;">

        <div style="display: flex; gap: 3rem; align-items: start;">

            <!-- Filters -->
            <aside class="filter-sidebar">
                <div class="card" style="padding: 1.5rem;">

                    <!-- Recommended Toggle -->
                    <div
                        style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--color-border); display: flex; align-items: center; justify-content: space-between;">
                        <span style="font-weight: 600; font-size: 0.95rem;">Recommended Sorting</span>
                        <label class="switch"
                            style="position: relative; display: inline-block; width: 40px; height: 22px;">
                            <input type="checkbox" id="sort-toggle" checked>
                            <span class="slider round"
                                style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; transition: .4s; border-radius: 22px;"></span>
                            <style>
                                .switch input {
                                    opacity: 0;
                                    width: 0;
                                    height: 0;
                                }

                                .slider:before {
                                    position: absolute;
                                    content: "";
                                    height: 16px;
                                    width: 16px;
                                    left: 3px;
                                    bottom: 3px;
                                    background-color: white;
                                    transition: .4s;
                                    border-radius: 50%;
                                }

                                input:checked+.slider {
                                    background-color: var(--color-sogang-red);
                                }

                                input:checked+.slider:before {
                                    transform: translateX(18px);
                                }
                            </style>
                        </label>
                    </div>

                    <div class="filter-group">
                        <h4>Project Type</h4>
                        <div id="filter-type" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Class Project,Capstone"> Class / Capstone
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Competition,Hackathon"> Competition / Hackathon
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Side Project"> Side Project
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Startup"> Startup
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Study Group"> Study Group
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Research"> Research
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Volunteering,Freelance"> Others
                            </label>
                        </div>
                    </div>

                    <div class="filter-group">
                        <h4>Domain</h4>
                        <div id="filter-domain" style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Web/App"> Web / App
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Mobile"> Mobile
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="AI/Data"> AI / Data Science
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Game Dev"> Game Development
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Blockchain,Fintech"> Blockchain / Fintech
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="E-commerce,SaaS,Enterprise"> Business / SaaS
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="IoT,Hardware"> Hardware / IoT
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Media Art,Design"> Media Art / Design
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Cloud Computing,Security"> Infra / Security
                            </label>
                            <label
                                style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--color-text-secondary);">
                                <input type="checkbox" value="Healthcare,EdTech,Social Media"> Others
                            </label>
                        </div>
                    </div>

                    <button id="apply-filters-btn" class="btn btn-secondary"
                        style="width: 100%; font-size: 0.9rem;">Apply Filters</button>
                </div>
            </aside>

            <!-- Grid -->
            <div id="projects-grid" class="projects-grid">
                <!-- Items injected via JS -->
            </div>

        </div>

    </main>

    <footer id="main-footer"></footer>

    <script src="../js/app.js"></script>
    <script>
        const PREDEFINED_TAG_CATEGORIES = {
            'Interest': [
                'Web/App', 'AI/Data', 'Fintech', 'Game Dev', 'Blockchain', 'E-commerce',
                'IoT', 'Metaverse', 'Cloud Computing', 'Security', 'Healthcare', 'EdTech',
                'Social Media', 'Enterprise', 'SaaS', 'Mobile'
            ],
            'Preference': [
                'Competition', 'Side Project', 'Startup', 'Study Group', 'Hackathon',
                'Capstone', 'Research', 'Volunteering', 'Freelance'
            ]
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const projects = await window.db.getProjects();
            const myProfile = await window.db.getProfile();
            let filteredProjects = [...projects];

            const grid = document.getElementById('projects-grid');
            const toggle = document.getElementById('sort-toggle');
            const applyBtn = document.getElementById('apply-filters-btn');

            function getCheckedValues(containerId) {
                return Array.from(document.querySelectorAll(`#${containerId} input:checked`)).map(cb => cb.value);
            }

            async function render() {
                // Skeleton Loading
                grid.innerHTML = Array(6).fill(0).map(() => `
                    <div class="card" style="height: 280px; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div class="skeleton" style="width: 80px; height: 24px; border-radius: 12px;"></div>
                        </div>
                        <div class="skeleton skeleton-title"></div>
                        <div class="skeleton skeleton-text"></div>
                        <div class="skeleton skeleton-text" style="width: 80%;"></div>
                        <div style="margin-top: auto; display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                             <div class="skeleton" style="width: 60px; height: 20px;"></div>
                             <div class="skeleton" style="width: 60px; height: 20px;"></div>
                        </div>
                        <div class="skeleton" style="width: 100%; height: 6px; border-radius: 3px;"></div>
                    </div>
                `).join('');

                const selectedTypes = getCheckedValues('filter-type');
                const selectedDomains = getCheckedValues('filter-domain');

                // Build filter object for API
                const filters = {};
                if (selectedTypes.length > 0) filters.type = selectedTypes.join(',');
                if (selectedDomains.length > 0) filters.domain = selectedDomains.join(',');

                // Fetch filtered projects from server
                let candidates = await window.db.getProjects(filters);

                // 2. Sort Logic
                if (toggle.checked && myProfile) {
                    candidates = candidates.map(p => {
                        let score = 0;

                        // 1. Role Match (40 pts)
                        const hasRoleMatch = (p.roles || []).some(r => r.role === myProfile.primaryRole && r.filled < r.count);
                        if (hasRoleMatch) score += 40;

                        // Identify User Tags by Category
                        const userPreferences = (myProfile.tags || []).filter(t => PREDEFINED_TAG_CATEGORIES['Preference'].includes(t));
                        const userInterests = (myProfile.tags || []).filter(t => PREDEFINED_TAG_CATEGORIES['Interest'].includes(t));

                        // 2. Normalized Type Match (30 pts max)
                        if (userPreferences.length > 0) {
                            const projectTypes = Array.isArray(p.type) ? p.type : [p.type];
                            const matchedTypes = projectTypes.filter(t => userPreferences.includes(t));
                            score += (matchedTypes.length / userPreferences.length) * 30;
                        }

                        // 3. Normalized Interest Match (30 pts max)
                        if (userInterests.length > 0) {
                            const projectDomains = Array.isArray(p.domain) ? p.domain : [p.domain];
                            const matchedInterests = projectDomains.filter(t => userInterests.includes(t));
                            score += (matchedInterests.length / userInterests.length) * 30;
                        }

                        return { ...p, recommendationScore: score };
                    }).sort((a, b) => b.recommendationScore - a.recommendationScore);
                } else if (!toggle.checked) {
                    // Recommended OFF: Random Shuffle
                    candidates = candidates.sort(() => Math.random() - 0.5);
                }

                // Render
                grid.innerHTML = candidates.map(p => {
                    // Logic to check if owner is included in roles (for correct Total Count)
                    const ownerId = (typeof p.owner === 'object') ? (p.owner._id || p.owner.id) : p.owner;
                    const ownerMember = (p.members || []).find(m => {
                        const mUserId = (typeof m.user === 'object') ? (m.user._id || m.user.id) : m.user;
                        return String(mUserId) === String(ownerId);
                    });
                    const ownerRole = ownerMember ? ownerMember.role : 'Leader';
                    const isOwnerIncluded = (p.roles || []).some(r => r.role === ownerRole);

                    const filledCount = (p.members && p.members.length > 0) ? p.members.length : 1;
                    const totalCount = (p.roles || []).reduce((acc, r) => acc + Number(r.count || 0), 0) + (isOwnerIncluded ? 0 : 1);

                    return `
                    <a href="./detail.html?id=${p.id}" class="card" style="text-decoration: none; color: inherit; display: block;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem;">
                            ${(Array.isArray(p.type) ? p.type : [p.type]).map(t => `<span class="badge blue">${t || 'Project'}</span>`).join('')}
                        </div>
                        <h3 style="font-size: 1.25rem; margin-bottom: 0.5rem; line-height: 1.4;">${p.title}</h3>
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 0.85rem; color: var(--color-text-secondary);">Leader:</span>
                            <span onclick="event.preventDefault(); showProfileCard('${ownerId}')" style="font-size: 0.85rem; font-weight: 600; color: var(--color-sogang-red); cursor: pointer; text-decoration: underline;">
                                ${p.owner?.name || 'Unknown'}
                            </span>
                        </div>
                        <p style="color: var(--color-text-secondary); font-size: 0.95rem; margin-bottom: 1rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                            ${p.oneLineDescription || ''}
                        </p>
                        <!-- Project current status -->
                        <div style="background: var(--color-bg-tertiary); padding: 0.75rem; border-radius: 8px; margin-bottom: 1.5rem; border-left: 3px solid var(--color-sogang-red);">
                            <span style="font-size: 0.75rem; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 0.25rem;">Latest Update</span>
                            <p style="font-size: 0.85rem; color: var(--color-text-primary); margin: 0; font-style: italic;">"${p.currentStatus || 'Recruiting starting members!'}"</p>
                        </div>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem;">
                            ${(p.roles || []).map(r => `
                                <span style="font-size: 0.8rem; background: var(--color-bg-secondary); padding: 2px 8px; border-radius: 4px; color: var(--color-text-secondary);">
                                    ${r.role} (${r.filled || 0}/${r.count})
                                </span>
                            `).join('')}
                        </div>

                        <!-- Team Status Summary -->
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <span style="font-size: 0.8rem; font-weight: 600; color: var(--color-text-primary);">Team Progress</span>
                                <span style="font-size: 0.8rem; color: var(--color-text-secondary);">
                                    ${filledCount} / ${totalCount}
                                </span>
                            </div>
                            <div style="width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden;">
                                <div style="height: 100%; background: var(--color-sogang-red); width: ${(filledCount / totalCount) * 100}%"></div>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid var(--color-border); padding-top: 1rem; display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                                ${(Array.isArray(p.domain) ? p.domain : [p.domain]).map(d => `<span style="font-size: 0.75rem; background: var(--color-bg-tertiary); padding: 2px 6px; border-radius: 4px; color: var(--color-text-tertiary);">${d}</span>`).join('')}
                            </div>
                            <span style="font-weight: 600; font-size: 0.9rem; color: var(--color-sogang-red);">View &rarr;</span>
                        </div>
                    </a >
                `;
                }).join('');

                if (candidates.length === 0) {
                    grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: var(--color-text-secondary); padding: 2rem;">No projects found matching criteria.</p>';
                }
            }

            // Events
            toggle.addEventListener('change', render);
            applyBtn.addEventListener('click', render);

            // Initial Render
            render();

        });
    </script>
</body>

</html>